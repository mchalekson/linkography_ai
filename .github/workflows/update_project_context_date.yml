name: Update PROJECT_CONTEXT date

on:
  push:
    branches:
      - main

jobs:
  update-date:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update Last updated date
        run: |
          python - <<'PY'
          from datetime import datetime, timezone
          from pathlib import Path
          import re

          path = Path('docs/PROJECT_CONTEXT.md')
          text = path.read_text(encoding='utf-8')

          date_str = datetime.now(timezone.utc).strftime('%B %d, %Y')
          pattern = r'(\*\*Last updated\*\*:\s*)(.+)'
          replacement = r"\1" + date_str
          new_text, n = re.subn(pattern, replacement, text, count=1)

          if n == 0:
            raise SystemExit('Last updated line not found')

          if new_text != text:
            path.write_text(new_text, encoding='utf-8')
          PY

      - name: Commit changes
        run: |
          if git status --porcelain | grep -q "docs/PROJECT_CONTEXT.md"; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add docs/PROJECT_CONTEXT.md
            git commit -m "Update PROJECT_CONTEXT date"
          fi

      - name: Push changes
        if: ${{ success() }}
        run: |
          if git status --porcelain | grep -q "docs/PROJECT_CONTEXT.md"; then
            git push
          fi
